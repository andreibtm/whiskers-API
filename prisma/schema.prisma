generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum BookStatus {
  WANT_TO_READ
  READING
  FINISHED
  DROPPED
}

enum SessionType {
  POMODORO
  FREE
}

model User {
  id        String           @id @default(uuid())
  email     String           @unique
  password  String
  role      Role             @default(USER)
  books     Book[]
  progress  Progress[]
  notes     Note[]
  sessions  ReadingSession[]
  streak    ReadingStreak?
  goals     ReadingGoal[]
  posts     Post[]
  likes     Like[]
  comments  Comment[]
  followers UserFollow[]     @relation("followers")
  following UserFollow[]     @relation("following")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model Book {
  id          String           @id @default(uuid())
  title       String
  author      String
  description String?
  coverUrl    String?
  totalPages  Int
  status      BookStatus       @default(WANT_TO_READ)
  finishedAt  DateTime?        @db.Timestamptz(6)
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  progress    Progress?
  notes       Note[]
  sessions    ReadingSession[]
  posts       Post[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([status])
}

model Progress {
  id          String    @id @default(uuid())
  currentPage Int       @default(0)
  percentage  Float     @default(0)
  startedAt   DateTime? @db.Timestamptz(6)
  finishedAt  DateTime? @db.Timestamptz(6)
  userId      String
  bookId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  book        Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Note {
  id        String   @id @default(uuid())
  content   String
  userId    String
  bookId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookId])
  @@index([userId])
}

model UserFollow {
  followerId String
  followedId String
  follower   User     @relation("following", fields: [followerId], references: [id], onDelete: Cascade)
  followed   User     @relation("followers", fields: [followedId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@id([followerId, followedId])
  @@index([followedId])
}

model ReadingSession {
  id              String      @id @default(uuid())
  userId          String
  bookId          String?
  type            SessionType @default(FREE)
  durationMinutes Int
  pagesRead       Int         @default(0)
  startedAt       DateTime    @db.Timestamptz(6)
  endedAt         DateTime?   @db.Timestamptz(6)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  book            Book?       @relation(fields: [bookId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([bookId])
}

model ReadingStreak {
  userId        String    @id
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastReadDate  DateTime? @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ReadingGoal {
  id             String   @id @default(uuid())
  userId         String
  year           Int
  targetBooks    Int
  completedBooks Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year])
  @@index([year])
}

model Post {
  id        String    @id @default(uuid())
  userId    String
  bookId    String?
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  book      Book?     @relation(fields: [bookId], references: [id], onDelete: SetNull)
  likes     Like[]
  comments  Comment[]

  @@index([userId])
  @@index([bookId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model Like {
  userId    String
  postId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([postId])
}

model Comment {
  id        String   @id @default(uuid())
  userId    String
  postId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}
